name: Deploy Flask API & Static Web to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-api:
    name: Build & Push Flask API
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: TP1/API

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ Authentifie le workflow avec le compte de service
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2️⃣ Installe gcloud (optionnel si déjà installé sur runner)
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: "latest"

      # 3️⃣ Configure Docker pour Artifact Registry
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker europe-west9-docker.pkg.dev --quiet

      # 4️⃣ Build et push de l’image Docker
      - name: Build and push Docker image
        run: |
          IMAGE_NAME=europe-west9-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/flask-api-repo/flask-api
          echo "Building and pushing image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

      # 5️⃣ Déploiement Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy flask-api \
            --image=europe-west9-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/flask-api-repo/flask-api:latest \
            --region=europe-west9 \
            --platform=managed \
            --allow-unauthenticated

  deploy-web:
    name: Upload static website to GCS
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: TP1/WEB
    needs: deploy-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Upload static site to GCS
        run: |
          echo "Syncing website to bucket..."
          # Utilise gcloud storage rsync à la place de gsutil
          gcloud storage rsync ./ gs://mon-site-web-bucket --delete
